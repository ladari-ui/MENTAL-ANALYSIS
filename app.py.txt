import streamlit as st
import pickle
from streamlit_mic_recorder import mic_recorder
import speech_recognition as sr
import tempfile
import os

# ---------------- PAGE CONFIG ----------------
st.set_page_config(page_title="Mental Health Emotion Analyzer", layout="centered")

# ---------------- LOAD MODEL ----------------
model = pickle.load(open("model.pkl", "rb"))
vectorizer = pickle.load(open("vectorizer.pkl", "rb"))

# ---------------- SIDEBAR NAVIGATION ----------------
st.sidebar.title("ğŸ§­ Navigation")
page = st.sidebar.radio("Go to", ["ğŸ  Home", "ğŸ§  Emotion Analyzer", "ğŸ“Š About", "ğŸ’¬ Contact"])

# =====================================================
# ğŸ  HOME PAGE
# =====================================================
if page == "ğŸ  Home":
    st.title("ğŸ’™ Mental Health Emotion Analyzer")
    st.write("Welcome! This app detects your emotions from text or speech using Machine Learning.")
    st.info("Use the sidebar to navigate and analyze your emotions.")

# =====================================================
# ğŸ§  EMOTION ANALYZER PAGE
# =====================================================
elif page == "ğŸ§  Emotion Analyzer":
    st.title("ğŸ§  Emotion Analyzer")
    st.write("Type OR Speak your feelings below ğŸ‘‡")

    user_input = ""

    # ğŸ¤ MIC BUTTON
    audio = mic_recorder(
        start_prompt="ğŸ¤ Start Recording",
        stop_prompt="Stop Recording",
        key="recorder"
    )

    # Convert speech to text
    if audio:
        st.info("Processing speech...")
        recognizer = sr.Recognizer()

        # Save temporary audio file
        with tempfile.NamedTemporaryFile(delete=False, suffix=".wav") as tmp_file:
            tmp_file.write(audio['bytes'])
            tmp_filename = tmp_file.name

        try:
            with sr.AudioFile(tmp_filename) as source:
                audio_data = recognizer.record(source)
                user_input = recognizer.recognize_google(audio_data)
                st.success("You said: " + user_input)
        except:
            st.error("Could not understand audio. Please try again.")
        finally:
            os.remove(tmp_filename)

    # âœ TEXT INPUT OPTION
    text_input = st.text_area("Or type here:")

    if text_input:
        user_input = text_input

    # ğŸ” ANALYZE BUTTON
    if st.button("Analyze Emotion"):
        if user_input.strip() == "":
            st.warning("Please speak or type something.")
        else:
            vec = vectorizer.transform([user_input])
            prediction = model.predict(vec)[0]

            emoji = {
                "joy": "ğŸ˜„",
                "sadness": "ğŸ˜¢",
                "anger": "ğŸ˜ ",
                "fear": "ğŸ˜¨",
                "love": "â¤ï¸",
                "surprise": "ğŸ˜²",
                "worry": "ğŸ˜Ÿ"
            }

            st.success(f"Detected Emotion: {prediction} {emoji.get(prediction,'ğŸ™‚')}")

            # ğŸˆ Balloons for joy
            if prediction == "joy":
                st.balloons()

            # ğŸ’¡ Wellness Tips
            tips = {
                "sadness": "Try talking to a friend or taking a short walk ğŸŒ¿",
                "anger": "Take deep breaths and relax ğŸ§˜",
                "fear": "Focus on slow breathing ğŸ’™",
                "worry": "Write down your thoughts âœï¸",
                "joy": "Spread your happiness ğŸŒ"
            }

            st.info(tips.get(prediction, "Take care of yourself ğŸ’™"))

# =====================================================
# ğŸ“Š ABOUT PAGE
# =====================================================
elif page == "ğŸ“Š About":
    st.title("ğŸ“Š About This Project")
    st.write("""
    This project is built using:
    - Python
    - Streamlit
    - Machine Learning
    - NLP (TF-IDF Vectorizer)

    It analyzes text or speech and predicts emotions.
    """)
    st.success("Created as a Mental Health Awareness Project ğŸ’™")

# =====================================================
# ğŸ’¬ CONTACT PAGE
# =====================================================
elif page == "ğŸ’¬ Contact":
    st.title("ğŸ’¬ Contact & Feedback")
    name = st.text_input("Your Name")
    feedback = st.text_area("Your Feedback")

    if st.button("Submit"):
        if name and feedback:
            st.success("Thank you for your feedback! ğŸ’™")
        else:
            st.warning("Please fill all fields.")